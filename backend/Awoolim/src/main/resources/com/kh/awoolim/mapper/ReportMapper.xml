<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.awoolim.mapper.ReportMapper">
	<insert id="create" parameterType="Report">
		INSERT INTO REPORT
		(REPORTNO,USERID,TARGETID,TYPE,CONTENT)
		VALUES(
		REPORT_SEQ.NEXTVAL,#{userId},#{targetId},#{type},#{content})
	</insert>
	<select id="list" resultType="Map" parameterType="int">
		SELECT
		R.REPORTNO,
		R.USERID,
		R.TARGETID,
		CASE
		WHEN R.type = 'user' AND M.USERNAME IS NOT NULL THEN M.USERNAME
		WHEN R.type = 'user' AND M.USERNAME IS NULL THEN '탈퇴한 사용자'
		WHEN R.type = 'club' AND C.CLUBTITLE IS NOT NULL THEN C.CLUBTITLE
		WHEN R.type = 'club' AND C.CLUBTITLE IS NULL THEN '삭제된 모임'
		ELSE '알 수 없는 사용자'
		END AS TARGETNAME,
		R.TYPE,
		R.CONTENT,
		TO_CHAR(R.REGDATE,'yy.mm.dd') as REGDATE,
		R.RESULT,
		R.RESULTMESSAGE
		FROM
		REPORT R
		LEFT JOIN
		MEMBER M ON R.TYPE = 'user' AND R.TARGETID = M.USERID
		LEFT JOIN
		CLUB C ON R.TYPE = 'club' AND R.TARGETID = C.CLUBNO
		WHERE
		R.USERID = #{userId}
		ORDER BY REGDATE
	</select>
	  <select id="selectReportList" resultType="Report">
        SELECT r.reportNo, m.userId AS userId, m.userName AS userName, r.targetId, r.content, r.regDate, r.result, r.resultMessage
        FROM report r
                 JOIN member m ON r.userId = m.userId
    </select>
    <delete id="deleteReport">
        DELETE FROM REPORT WHERE reportNo = #{reportNo};
    </delete>
    <update id="updateReportResult">
        BEGIN
        UPDATE REPORT SET result = #{result}, resultMessage = #{resultMessage} WHERE reportNo = #{reportNo};
        IF #{result} = 1 THEN
            process_warning(#{targetId});
        END IF;
        END;
    </update>
</mapper>